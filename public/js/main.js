const slides = [{
    location: 'Clientes y Proveedores',
    title: 'Portal E2M',
    description: 'Plataforma integral para la gestión de servicios eléctricos y soluciones energéticas especializadas en el Mercado Eléctrico Mexicano',
    background: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1920&auto=format&fit=crop',
    cards: [{
        location: 'Empresas ≥1 MW',
        title: 'Usuarios Calificados',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Optimización MEM',
        title: 'Centrales Eléctricas',
        image: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Energías Limpias',
        title: 'Sostenibilidad',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    }
    ]
},
{
    location: 'Empresas ≥1 MW',
    title: 'Usuarios<br>Calificados',
    description: 'Servicios especializados para empresas con demanda igual o mayor a 1 MW, optimizando costos energéticos y eficiencia operativa',
    background: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1920&auto=format&fit=crop',
    cards: [{
        location: 'Clientes y Proveedores',
        title: 'Portal E2M',
        image: 'https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Optimización MEM',
        title: 'Centrales Eléctricas',
        image: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Usuarios Calificados',
        title: 'Generación Propia',
        image: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    }
    ]
},
{
    location: 'Optimización MEM',
    title: 'Centrales<br>Eléctricas',
    description: 'Gestión y optimización de centrales eléctricas en el Mercado Eléctrico Mexicano con tecnología avanzada y análisis especializado',
    background: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1920&auto=format&fit=crop',
    cards: [{
        location: 'Empresas ≥1 MW',
        title: 'Usuarios Calificados',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Energías Limpias',
        title: 'Sostenibilidad',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Usuarios Calificados',
        title: 'Generación Propia',
        image: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    }
    ]
},
{
    location: 'Energías Limpias',
    title: 'Sostenibilidad<br>Energética',
    description: 'Soluciones sustentables y energías renovables para empresas comprometidas con el medio ambiente y la eficiencia energética',
    background: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1920&auto=format&fit=crop',
    cards: [{
        location: 'Usuarios Calificados',
        title: 'Generación Propia',
        image: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Clientes y Proveedores',
        title: 'Portal E2M',
        image: 'https://images.unsplash.com/photo-1473341304170-971dccb5ac1e?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Optimización MEM',
        title: 'Centrales Eléctricas',
        image: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    }
    ]
},
{
    location: 'Usuarios Calificados',
    title: 'Generación<br>Propia',
    description: 'Servicios especializados para usuarios calificados con generación propia, maximizando el aprovechamiento de recursos energéticos',
    background: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=80&w=1920&auto=format&fit=crop',
    cards: [{
        location: 'Energías Limpias',
        title: 'Sostenibilidad',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Optimización MEM',
        title: 'Centrales Eléctricas',
        image: 'https://images.unsplash.com/photo-1466611653911-95081537e5b7?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    },
    {
        location: 'Empresas ≥1 MW',
        title: 'Usuarios Calificados',
        image: 'https://images.unsplash.com/photo-1497435334941-8c899ee9e8e9?q=95&w=800&auto=format&fit=crop&ixlib=rb-4.0.3'
    }
    ]
}
];

let currentSlide = 0;
let isAnimating = false;

// DOM elements
const mainContainer = document.getElementById('mainContainer');
const heroLogo = document.getElementById('heroLogo');
const heroDivider = document.getElementById('heroDivider');
const heroTagline = document.getElementById('heroTagline');
const heroActions = document.getElementById('heroActions');

// Enhanced animation function with staggered card animations
function updateSlide(index, direction = 'next') {
    if (isAnimating) return;
    isAnimating = true;

    const slide = slides[index];

    // Animate out current content
    const timeline = [
        () => {
            heroLogo && (heroLogo.style.opacity = '0');
            heroLogo && (heroLogo.style.transform = 'translateY(-12px)');
        },
        () => {
            heroDivider && (heroDivider.style.opacity = '0');
            heroDivider && (heroDivider.style.transform = 'scaleX(.8)');
        },
        () => {
            heroTagline && (heroTagline.style.opacity = '0');
            heroTagline && (heroTagline.style.transform = 'translateY(12px)');
        },
        () => {
            heroActions && (heroActions.style.opacity = '0');
            heroActions && (heroActions.style.transform = 'translateY(12px)');
        }
    ];

    // Execute animations with delays
    timeline.forEach((animation, i) => {
        setTimeout(animation, i * 150);
    });

    // Update background with smooth transition
    setTimeout(() => {
        mainContainer.style.backgroundImage = `url('${slide.background}')`;
    }, 300);

    // Animate content back in
    setTimeout(() => {
        heroLogo && (heroLogo.style.opacity = '1');
        heroLogo && (heroLogo.style.transform = 'translateY(0)');
    }, 220);
    setTimeout(() => {
        heroDivider && (heroDivider.style.opacity = '1');
        heroDivider && (heroDivider.style.transform = 'scaleX(1)');
    }, 300);
    setTimeout(() => {
        heroTagline && (heroTagline.style.opacity = '1');
        heroTagline && (heroTagline.style.transform = 'translateY(0)');
    }, 380);
    setTimeout(() => {
        heroActions && (heroActions.style.opacity = '1');
        heroActions && (heroActions.style.transform = 'translateY(0)');
    }, 460);



    // Reset animation flag
    setTimeout(() => {
        isAnimating = false;
    }, 1500);
}

// Enhanced card update with staggered animations
function updateCards(cards, direction) {
    const existingCards = destinationCards.querySelectorAll('.destination-card');

    // Animate out existing cards
    existingCards.forEach((card, i) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = direction === 'next' ? 'translateX(40px) rotateY(12deg)' : 'translateX(-40px) rotateY(-12deg)';
        }, i * 130);
    });

    // Clear and create new cards
    setTimeout(() => {
        destinationCards.innerHTML = '';

        cards.forEach((card, i) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'destination-card';
            cardElement.style.opacity = '0';
            cardElement.style.transform = direction === 'next' ? 'translateX(-40px) rotateY(-12deg)' : 'translateX(40px) rotateY(12deg)';
            cardElement.style.backgroundImage = `linear-gradient(to top, rgba(0, 0, 0, .55), rgba(0, 0, 0, .12)), url(${card.image})`;
            cardElement.style.backgroundSize = 'cover';
            cardElement.style.backgroundPosition = 'center';

            // Determine the appropriate link based on the card title
            let cardLink = '#';
            if (card.title === 'Usuarios Calificados') {
                cardLink = 'https://e2m.mx/usuarios-calificados/';
            } else if (card.title === 'Centrales Eléctricas') {
                cardLink = 'https://e2m.mx/centrales-electricas/';
            } else if (card.title === 'Sostenibilidad') {
                cardLink = 'https://e2m.mx/sostenibilidad-empresarial/';
            } else if (card.title === 'Generación Propia') {
                cardLink = 'https://e2m.mx/usuarios-calificados-con-generacion-propia/';
            } else if (card.title === 'Portal E2M') {
                cardLink = 'https://portal.e2m.mx/login';
            }

            cardElement.innerHTML = `
                        <a href="${cardLink}" target="${card.title === 'Portal E2M' ? '_self' : '_blank'}" class="block h-full">
                            <div class="card-overlay">
                                <div class="card-badge">${card.location}</div>
                                <div class="card-title">${card.title}</div>
                            </div>
                        </a>
                    `;

            destinationCards.appendChild(cardElement);

            setTimeout(() => {
                cardElement.style.opacity = '1';
                cardElement.style.transform = 'translateX(0)';
            }, i * 180 + 140);
        });
    }, 300);
}

// Navigation functions with direction tracking
function nextSlide() {
    if (isAnimating) return;
    currentSlide = (currentSlide + 1) % slides.length;
    updateSlide(currentSlide, 'next');
    updateIndicators();
}

function prevSlide() {
    if (isAnimating) return;
    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
    updateSlide(currentSlide, 'prev');
    updateIndicators();
}

// Enhanced event listeners with animation prevention
let autoTimer = setInterval(() => {
    if (!isAnimating) nextSlide();
}, 8000);

// Mobile navigation controls
// Mobile arrows removed
const slideIndicators = document.querySelectorAll('.slide-indicator');

// Mobile navigation event listeners
// No manual mobile controls

// Slide indicator event listeners
slideIndicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
        if (!isAnimating && index !== currentSlide) {
            currentSlide = index;
            updateSlide(currentSlide);
            updateIndicators();
        }
    });
});

// Update slide indicators
function updateIndicators() {
    slideIndicators.forEach((indicator, index) => {
        indicator.classList.toggle('active', index === currentSlide);
    });
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight') nextSlide();
    if (e.key === 'ArrowLeft') prevSlide();
});

// Add transition styles to elements
function initializeTransitions() {
    heroLogo && (heroLogo.style.transition = 'all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)');
    heroDivider && (heroDivider.style.transition = 'all 0.7s cubic-bezier(0.2, 0.8, 0.2, 1)');
    heroTagline && (heroTagline.style.transition = 'all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)');
    heroActions && (heroActions.style.transition = 'all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)');
    heroActions && (heroActions.style.opacity = '0');
    heroActions && (heroActions.style.transform = 'translateY(12px)');
}

// Initialize the slider
function initializeSlider() {
    initializeTransitions();
    if (slides && slides.length && mainContainer) {
        mainContainer.style.backgroundImage = `url('${slides[currentSlide].background}')`;
    }
    updateSlide(currentSlide);
    updateIndicators();
}

// Navbar functionality
function initializeNavbar() {
    // Mobile menu toggle
    const mobileMenuBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.querySelector('.mobile-menu');
    const headerBar = document.getElementById('headerBar');
    const logoBox = document.getElementById('logoBox');
    const navPrimary = document.getElementById('navPrimary');
    const authBox = document.getElementById('authBox');
    const loginLink = authBox ? authBox.querySelector('.login-btn') : null;
    const registerLink = authBox ? authBox.querySelector('.register-btn') : null;

    if (mobileMenuBtn && mobileMenu) {
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
            const expanded = mobileMenu.classList.contains('active');
            mobileMenuBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        });
    }

    // Mobile dropdown toggle
    const mobileDropdownTrigger = document.querySelector('.mobile-dropdown-trigger');
    const mobileDropdownContent = document.querySelector('.mobile-dropdown-content');
    const mobileDropdownArrow = document.querySelector('.mobile-dropdown-arrow');

    if (mobileDropdownTrigger && mobileDropdownContent) {
        mobileDropdownTrigger.addEventListener('click', () => {
            mobileDropdownContent.classList.toggle('hidden');
            mobileDropdownArrow.style.transform = mobileDropdownContent.classList.contains('hidden') ?
                'rotate(0deg)' :
                'rotate(180deg)';
        });
    }


    document.addEventListener('click', (e) => {
        if (!mobileMenu || !mobileMenuBtn) return;
        if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
            mobileMenu.classList.remove('active');
            mobileMenuBtn.setAttribute('aria-expanded', 'false');
        }
    });

    function updateNavbarLayout() {
        if (!headerBar || !logoBox || !navPrimary || !authBox || !mobileMenuBtn) return;
        const available = headerBar.clientWidth - 32;
        const required = logoBox.scrollWidth + navPrimary.scrollWidth + authBox.scrollWidth;
        const forceMobile = window.innerWidth <= 1024;
        if (required > available || forceMobile) {
            navPrimary.classList.add('hidden');
            mobileMenuBtn.classList.remove('hidden');
            if (loginLink) loginLink.classList.add('hidden');
            if (registerLink) registerLink.classList.add('hidden');
        } else {
            navPrimary.classList.remove('hidden');
            mobileMenuBtn.classList.add('hidden');
            mobileMenu.classList.remove('active');
            if (loginLink) loginLink.classList.remove('hidden');
            if (registerLink) registerLink.classList.remove('hidden');
        }
    }

    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(updateNavbarLayout, 100);
    });
    updateNavbarLayout();
}

// Start when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initializeSlider();
    // Menú móvil controlado por clase .active (sin inline display)
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    if (prevBtn && nextBtn) {
        prevBtn.addEventListener('click', () => {
            if (!isAnimating) prevSlide();
        });
        nextBtn.addEventListener('click', () => {
            if (!isAnimating) nextSlide();
        });
    }
    const nf = document.getElementById('newsletter-form');
    if (nf) {
        nf.addEventListener('submit', e => {
            e.preventDefault();
            document.getElementById('newsletter-toast').classList.remove('hidden');
        });
    }
    const cf = document.getElementById('contact-form');
    if (cf) {
        cf.addEventListener('submit', e => {
            e.preventDefault();
            document.getElementById('contact-toast').classList.remove('hidden');
        });
        const phoneInput = document.getElementById('contact-phone');
        const countrySelect = document.getElementById('countrySelect');
        const ISO_BY_DIAL = {
            '52': 'mx',
            '1': 'us',
            '34': 'es',
            '44': 'gb',
            '57': 'co',
            '55': 'br',
            '54': 'ar',
            '51': 'pe',
            '56': 'cl',
            '33': 'fr'
        };

        function updatePhonePlaceholder() {
            if (!phoneInput || !countrySelect) return;
            phoneInput.placeholder = `+${countrySelect.value} Número de teléfono`;
        }

        function updateCountryFlag() {
            if (!countrySelect) return;
            const iso = ISO_BY_DIAL[countrySelect.value] || 'mx';
            countrySelect.style.backgroundImage = `url('https://flagcdn.com/24x18/${iso}.png')`;
            countrySelect.style.backgroundRepeat = 'no-repeat';
            countrySelect.style.backgroundPosition = '12px 50%';
            countrySelect.style.backgroundSize = '24px 18px';
        }
        countrySelect && countrySelect.addEventListener('change', () => {
            updatePhonePlaceholder();
            updateCountryFlag();
        });
        updatePhonePlaceholder();
        updateCountryFlag();
    }
    
    const snapSections = Array.from(document.querySelectorAll('#mainContainer, #nosotros, #servicios, #blog, #contacto'));
    let sectionAnimating = false;
    let activeSectionIndex = 0;
    if (snapSections.length) {
        const observer = new IntersectionObserver((entries) => {
            let maxRatio = 0;
            let idx = activeSectionIndex;
            entries.forEach((entry) => {
                if (entry.isIntersecting && entry.intersectionRatio > maxRatio) {
                    maxRatio = entry.intersectionRatio;
                    idx = snapSections.indexOf(entry.target);
                }
            });
            if (idx !== activeSectionIndex) {
                activeSectionIndex = idx;
                toggleBackBtn();
            }
        }, { threshold: [0.5, 0.6, 0.8, 1] });
        snapSections.forEach((el) => observer.observe(el));
    }

    function currentSectionIndex() {
        const y = window.scrollY;
        let idx = 0;
        let min = Infinity;
        snapSections.forEach((el, i) => {
            const top = el.getBoundingClientRect().top + window.scrollY;
            const d = Math.abs(top - y);
            if (d < min) {
                min = d;
                idx = i;
            }
        });
        return idx;
    }

    function snapTo(index) {
        if (!snapSections[index]) return;
        sectionAnimating = true;
        snapSections[index].scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
        setTimeout(() => {
            sectionAnimating = false;
        }, 700);
    }
    window.addEventListener('wheel', (e) => {
        if (sectionAnimating) return;
        if (Math.abs(e.deltaY) < 30) return;
        const idx = currentSectionIndex();
        const nextIdx = e.deltaY > 0 ? Math.min(idx + 1, snapSections.length - 1) : Math.max(idx - 1, 0);
        if (nextIdx !== idx) {
            e.preventDefault();
            snapTo(nextIdx);
        }
    }, {
        passive: false
    });

    document.addEventListener('keydown', (e) => {
        if (sectionAnimating) return;
        const idx = currentSectionIndex();
        if (e.key === 'ArrowDown' || e.key === 'PageDown') {
            e.preventDefault();
            snapTo(Math.min(idx + 1, snapSections.length - 1));
        }
        if (e.key === 'ArrowUp' || e.key === 'PageUp') {
            e.preventDefault();
            snapTo(Math.max(idx - 1, 0));
        }
    });

    const backBtn = document.getElementById('backToTopBtn');
    function toggleBackBtn() {
        if (!backBtn) return;
        backBtn.classList.toggle('visible', activeSectionIndex > 0);
    }
    toggleBackBtn();
    window.addEventListener('scroll', toggleBackBtn);
    document.addEventListener('wheel', toggleBackBtn, { passive: true });
    document.addEventListener('keydown', toggleBackBtn);
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            if (typeof snapTo === 'function') {
                snapTo(0);
            } else {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    }
});
